<odoo>
    <template id="portal_whatsapp_qr_list" name="Mis servicios WhatsApp QR">
        <t t-call="portal.portal_layout">
            <div class="o_portal_my_doc_table">
                <t t-if="request.session.get('portal_message')">
                    <div class="alert alert-info" role="alert">
                        <t t-esc="request.session.pop('portal_message')"/>
                    </div>
                </t>
                <h2>Mis servicios de WhatsApp</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Teléfono</th>
                            <th>Servicio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="qr_records" t-as="qr">
                            <tr>
                                <td><t t-esc="qr.phone_number"/></td>
                                <td><t t-esc="qr.name"/></td>
                                <td>
                                    <a t-att-href="'/my/whatsapp_qr/%d' % qr.id" class="btn btn-primary btn-sm">Ver Detalle</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>

    <template id="portal_whatsapp_qr_detail" name="Detalle WhatsApp QR">
        <t t-call="portal.portal_layout">
            <div class="o_portal_my_doc_table">
                <h2>Detalle del Servicio WhatsApp</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><b>Teléfono:</b> <t t-esc="qr.phone_number"/></p>
                    </div>
                    <div class="col-md-6">
                        <p><b>Servicio:</b> <t t-esc="qr.name"/></p>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Código QR de Vinculación</h5>
                    </div>
                    <div class="card-body text-center" style="background-color: #f8f8f8;">
                        <pre id="qr_code_block" style="font-size:6px; background:#ffffff; padding:20px; line-height: 1; display: inline-block; font-family: 'Courier New', monospace; letter-spacing: 0; white-space: pre; border: 2px solid #ddd; border-radius: 5px;"><t t-esc="qr.qr_code or 'Cargando QR...'"/></pre>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="update_qr_btn" type="button">
                                <i class="fa fa-refresh"></i> Actualizar QR
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Últimos Logs del Contenedor</h5>
                    </div>
                    <div class="card-body" style="background-color: #2d2d2d; color: #cccccc;">
                        <pre id="logs_block" style="font-size:11px; background: transparent; padding:10px; max-height:400px; overflow:auto; font-family: monospace; white-space: pre-wrap; margin: 0; color: #cccccc;"><t t-esc="qr.logs_preview or 'Cargando logs...'"/></pre>
                        <div class="mt-3">
                            <button class="btn btn-secondary" id="update_logs_btn" type="button">
                                <i class="fa fa-refresh"></i> Actualizar Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                $(function(){
                    var qr_id = <t t-esc="qr.id"/>;
                    function updateLogs() {
                        $('#update_logs_btn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Actualizando...');
                        var url = '/my/whatsapp_qr/' + qr_id + '/update_logs';
                        $.jsonRpc(url, 'call', {}).then(function(data){
                            if(data.logs){
                                $('#logs_block').text(data.logs);
                            }
                            $('#update_logs_btn').prop('disabled', false).html('<i class="fa fa-refresh"></i> Actualizar Logs');
                        });
                    }
                    function updateQR() {
                        $('#update_qr_btn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Actualizando...');
                        var url = '/my/whatsapp_qr/' + qr_id + '/update_qr';
                        $.jsonRpc(url, 'call', {}).then(function(data){
                            if(data.qr_code){
                                $('#qr_code_block').text(data.qr_code);
                            }
                            $('#update_qr_btn').prop('disabled', false).html('<i class="fa fa-refresh"></i> Actualizar QR');
                        });
                    }
                    $('#update_logs_btn').on('click', updateLogs);
                    $('#update_qr_btn').on('click', updateQR);
                    // Actualización automática cada 10 segundos
                    setInterval(function(){
                        updateLogs();
                        updateQR();
                    }, 10000);
                });
            </script>
        </t>
    </template>
</odoo>
