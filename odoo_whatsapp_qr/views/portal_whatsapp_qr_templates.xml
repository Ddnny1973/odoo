<odoo>
    <template id="portal_whatsapp_qr_list" name="Mis servicios WhatsApp QR">
        <t t-call="portal.portal_layout">
            <div class="o_portal_my_doc_table">
                <t t-if="request.session.get('portal_message')">
                    <div class="alert alert-info" role="alert">
                        <t t-esc="request.session.pop('portal_message')"/>
                    </div>
                </t>
                <h2>Mis servicios de WhatsApp</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Teléfono</th>
                            <th>Servicio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="qr_records" t-as="qr">
                            <tr>
                                <td><t t-esc="qr.phone_number"/></td>
                                <td><t t-esc="qr.name"/></td>
                                <td>
                                    <a t-att-href="'/my/whatsapp_qr/%d' % qr.id" class="btn btn-primary btn-sm">Ver Detalle</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>

    <template id="portal_whatsapp_qr_detail" name="Detalle WhatsApp QR">
        <t t-call="portal.portal_layout">
            <div class="o_portal_my_doc_table">
                <h2>Detalle del Servicio WhatsApp</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><b>Teléfono:</b> <t t-esc="qr.phone_number"/></p>
                    </div>
                    <div class="col-md-6">
                        <p><b>Servicio:</b> <t t-esc="qr.name"/></p>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Código QR de Vinculación</h5>
                    </div>
                    <div class="card-body text-center" style="background-color: #f8f8f8; padding: 20px; display: flex; justify-content: center; align-items: center;">
                        <div style="display: inline-block; border: 3px solid #333; padding: 15px; background: white;">
                            <pre id="qr_code_block" style="font-size:8px; background:#ffffff; line-height: 1; font-family: 'Courier New', monospace; white-space: pre; letter-spacing: 0; margin: 0; padding: 0; aspect-ratio: 1 / 1; max-height: 500px; overflow: hidden;"><t t-esc="qr.qr_code or 'Cargando QR...'"/></pre>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="update_qr_btn" type="button">
                                <i class="fa fa-refresh"></i> Actualizar QR
                            </button>
                            <p class="small text-muted mt-2" style="margin: 0;">Última actualización: <span id="qr_last_update">--:--:--</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Últimos Logs del Contenedor</h5>
                    </div>
                    <div class="card-body" style="background-color: #2d2d2d; color: #cccccc;">
                        <pre id="logs_block" style="font-size:11px; background: transparent; padding:10px; max-height:400px; overflow:auto; font-family: monospace; white-space: pre-wrap; margin: 0; color: #cccccc;"><t t-esc="qr.logs_preview or 'Cargando logs...'"/></pre>
                        <div class="mt-3">
                            <button class="btn btn-secondary" id="update_logs_btn" type="button">
                                <i class="fa fa-refresh"></i> Actualizar Logs
                            </button>
                            <p class="small" style="margin: 0; margin-top: 10px; color: #cccccc;">Última actualización: <span id="logs_last_update">--:--:--</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
                <![CDATA[
                $(function(){
                    var qr_id = <t t-esc="qr.id"/>;
                    var qrLastUpdate = $('#qr_last_update');
                    var logsLastUpdate = $('#logs_last_update');
                    
                    function updateTimestamp(element) {
                        if (element.length) {
                            var now = new Date();
                            var hours = String(now.getHours()).padStart(2, '0');
                            var minutes = String(now.getMinutes()).padStart(2, '0');
                            var seconds = String(now.getSeconds()).padStart(2, '0');
                            element.text(hours + ':' + minutes + ':' + seconds);
                        }
                    }
                    
                    function updateLogs() {
                        $('#update_logs_btn').prop('disabled', true).text('Actualizando...');
                        $.jsonRpc('/my/whatsapp_qr/' + qr_id + '/update_logs', 'call', {})
                            .done(function(data) {
                                if (data.logs) {
                                    $('#logs_block').text(data.logs);
                                    $('#logs_block').parent().scrollTop($('#logs_block').parent()[0].scrollHeight);
                                    console.log('Logs actualizados');
                                }
                                updateTimestamp(logsLastUpdate);
                            })
                            .fail(function(error) {
                                console.error('Error actualizando logs:', error);
                            })
                            .always(function() {
                                $('#update_logs_btn').prop('disabled', false).html('<i class="fa fa-refresh"></i> Actualizar Logs');
                            });
                    }
                    
                    function updateQR() {
                        $('#update_qr_btn').prop('disabled', true).text('Actualizando...');
                        $.jsonRpc('/my/whatsapp_qr/' + qr_id + '/update_qr', 'call', {})
                            .done(function(data) {
                                if (data.qr_code) {
                                    $('#qr_code_block').text(data.qr_code);
                                    $('#qr_code_block')[0].scrollTop = $('#qr_code_block')[0].scrollHeight;
                                    console.log('QR actualizado');
                                }
                                updateTimestamp(qrLastUpdate);
                            })
                            .fail(function(error) {
                                console.error('Error actualizando QR:', error);
                            })
                            .always(function() {
                                $('#update_qr_btn').prop('disabled', false).html('<i class="fa fa-refresh"></i> Actualizar QR');
                            });
                    }
                    
                    // Inicializar timestamps
                    updateTimestamp(qrLastUpdate);
                    updateTimestamp(logsLastUpdate);
                    
                    // Event listeners
                    $('#update_logs_btn').on('click', updateLogs);
                    $('#update_qr_btn').on('click', updateQR);
                    
                    // Scroll inicial
                    $('#qr_code_block')[0].scrollTop = $('#qr_code_block')[0].scrollHeight;
                    
                    // Auto-update cada 10 segundos
                    setInterval(function(){
                        updateQR();
                        updateLogs();
                    }, 10000);
                });
                ]]>
            </script>
        </t>
    </template>
</odoo>
